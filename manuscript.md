# 外苑祭の受付システム制作

![外苑祭チケットシステム](./images/ogp.png)

## はじめに

今までの外苑祭の受付には、以下のような問題があった。

- 校内に入るときの受付が大変混雑する。
- 紙の招待券では、直接渡すのが手間。
- 自由にキャンセルができない。

そのため、私たちはこの課題を改善するために、外苑祭の受付システムを制作することにした。

今回作成したページおよびソースコードは、以下のサイトで公開されている。

- [外苑祭チケットシステム](https://rio-gunawan.github.io/gaiensai-ticket/)

  <img src="./images/page_qr.png" alt="ページのQRコード" width="200" />

- [ソースコード](https://github.com/Rio-Gunawan/gaiensai-ticket)

  <img src="./images/source_qr.png" alt="ソースコードのQRコード" width="200" />

## 使用したプログラミング言語

- HTML
- CSS
- JavaScript

また、JavaScript のライブラリとして以下のものを利用した。

- [jQuery](https://jquery.com/)
- [qrcode.js](https://davidshimjs.github.io/qrcodejs/)
- [html5-qrcode.js](https://github.com/mebjas/html5-qrcode)

開発には[Visual Studio Code](https://code.visualstudio.com/)を用いて、[Github Pages](https://docs.github.com/ja/pages)を用いてホスティングした。また、一部のコードは Copilot や Gemini 等の AI に相談して記述した。

## 実装すべき項目

- 公演の情報が入った QR コードを生成し、それを読み取るシステム。
- 統計を取るために、読み取り履歴を保存。
- 不正に QR コードを作成されにくい仕組み。
- 共有にはスクリーンショットおよび URL を用いるようにして、受け取った人はそれを開くだけで受付ができる仕組み。
- チケット読み取り時に、それが正規の QR コードであるか、および正しいクラス・公演回のものを読み取ったのかを判定する仕組み。

## コードの仕組み

上記の「実装すべき項目」をどのようにして実装したかを説明する。

### 1. QR コード生成とスキャン

- QR 生成: [チケット生成ページ](https://rio-gunawan.github.io/gaiensai-ticket/issue.html)に必要事項を入力すると、そのデータを元に QR コードを生成する（仕組みは後述）。生成した QR コードは、`show.html?id=QRコードの内容`と URL に打ち込むことで表示できる。(例:[https://rio-gunawan.github.io/gaiensai-ticket/show.html?id=ZuXXFa](https://rio-gunawan.github.io/gaiensai-ticket/show.html?id=ZuXXFa))
- スキャン: [チケット読み取りページ](https://rio-gunawan.github.io/gaiensai-ticket/scan.html)で、`html5-qrcode.js`というライブラリを用いて、カメラを起動し QR コードをスキャンする。読み取った数字は元のデータ(公演のクラス・回・間柄など)に復元して、ブラウザの`LocalStorage`に保存する。

### 2. 読み取り履歴の保存

- 読み取り時にブラウザの`LocalStorage`に**読み取り日時**、**QR コードの番号**、**有効性**を保存。
- [読み取り履歴ページ](https://rio-gunawan.github.io/gaiensai-ticket/history.html)にて、来場者数の合計や、クラス・公演回ごとの来場者数を表示可能。また、QR コードの番号から復元したデータを一覧で表示すること、それを CSV 形式でダウンロードし、Excel 等の表計算アプリで編集も可能。

### 3. QR コードを生成する仕組み

1. 入力したデータを、規則に沿って数字に変換。
   - 学年・クラス・番号: そのまま繋げる(例: 1 年 1 組 1 番 → 1101)
   - 関係: 選択肢に順番に 0 から番号付け(例: 本人 →0、家族 →1、友人(青高生)→2)
   - 公演のクラス: クラスを 0 から順番に、2 桁で番号付け(例: 1 年 1 組 →00、2 年 7 組 →13)
   - 公演回: そのまま番号にする
2. 1\.のデータをそのまま結合(例:1 年 1 組 1 番、家族、2 年 7 組、第 2 公演 →11011132)
3. 2\.のデータを 62 進数(0\~9、a\~z、A\~Z の 62 文字)に変換する要領でアルファベットに変換。ただし、この 62 進数は文字がランダムに配置されていて、その順番が配列`randomCharacter`に格納されている。

   ```javascript
   // 62進数にするときの文字の順番。0→n、1→0、2→aというように対応している。
   const randomCharacter = ['n', '0', 'a', '3', 'O', '7', 'k', 'E', …];

   // アルファベット化する関数(encryptとなっているが、厳密な意味では暗号ではない)
   function encrypt(data) {
       // dataは2.で生成した数字8桁のデータ。
       let result = '';
       while (data >= 62) {
           const remainder = data % 62;
           result = randomCharacter[remainder] + result;
           data = Math.floor(data / 62);
       }
       result = randomCharacter[data] + result;
       return result;
   }
   ```

4. 3\.で変換されたデータの先頭に、これが何枚目かを`LocalStorage`から取得し、`randomCharacter`を用いてアルファベット 1 文字に変換して追加。仕組み上 62 枚までしか作れないが、1 公演 50 人までなので十分であろう。また、ここの数字の変化で`randomCharacter`を推測されないよう、スタート地点や幅(`randomCharacter`を 1 番目、4 番目、7 番目…などと飛び飛びに取得しているのだが、その飛ばす幅。この例では幅は3である)を、入力データをもとに変えている。

5. 4\.で作成したデータの末尾にチェックディジットを追加し、入力ミスを検知。

   ```javascript
   // 62進数にするときの文字の順番。0→n、1→0、2→aというように対応している。
   const randomCharacter = ['n', '0', 'a', '3', 'O', '7', 'k', 'E', …];

   function makeCheckDigit(data) {
       // dataは4.で生成したアルファベット5~6文字
       let sum = 0;
       for (let i = 0; i < data.length; i++) {
           const index = randomCharacter.indexOf(data[i]);
           sum += index * (i + 1);
       }
       const checkDigitIndex = sum % 62;
       return randomCharacter[checkDigitIndex];
   }
   ```

### 4. チケット読み取り時に、有効な QR コードであるかを判定する仕組み

- 基本的に、3\. の QR コード生成の仕組みを逆にたどって判定。

  判定項目

  - チェックディジットが正しいか
  - 学年クラスや公演回などが正しい数字であるか(例:学年は 1~3 の自然数のみなので、5 年となっていたら無効)

  ```javascript
   // 62進数にするときの文字の順番。0→n、1→0、2→aというように対応している。
  const randomCharacter = ['n', '0', 'a', '3', 'O', '7', 'k', 'E', …];

  function IsAuthentic(decodedData) {
    // decodedDataはQRコードを元のデータに復元したときのデータを格納したObject型。
    // decodedData.rawでQRコードの数字を取得できる
    const providedCheckDigit = decodedData.raw.slice(-1);
    const expectedCheckDigit = calculateCheckDigit(originalData);
    // チェックディジットを比較
    if (providedCheckDigit !== expectedCheckDigit) {
        return false;
    }

    // 学年クラスなどが正しい範囲であるかを確認
    if (!(1 <= decodedData.grade && decodedData.grade <= 3)) {
        return false;
    } if (!(1 <= decodedData.classNum && decodedData.classNum <= 7)) {
        return false;
    } if (!(1 <= decodedData.Number && decodedData.Number <= 42)) {
        return false;
    } if (!(0 <= decodedData.relationRaw && decodedData.relationRaw <= 4)) {
        return false;
    } if (!(0 <= decodedData.performanceId && decodedData.performanceId <= 20)) {
        return false;
    } if (!(1 <= decodedData.times && decodedData.times <= 8)) {
        return false;
    }
    return true;
  }

  function calculateCheckDigit(data) {
    let sum = 0;
    for (let i = 0; i < data.length; i++) {
        const index = randomCharacter.indexOf(data[i]);
        sum += index * (i + 1);
    }
    const checkDigitIndex = sum % 62;
    return randomCharacter[checkDigitIndex];
  }
  ```

  - 読み取りモードで「校内入場」以外の各クラス、および公演回を選択した場合、そのクラス・公演回であるかを確認。
  - `LocalStorage` を参照して、再入場かどうかを判定。

### 注意

この工程で、一般の人が少し操作するだけで不正に QR コードが作れてしまうという事態は防げるが、

- 読み込み履歴をデバイス間で共有していないため、複数デバイスで運用した場合、別の端末で読み込むと再入場を検知できない。
- このアルゴリズムおよび`randomCharacter`(鍵)は全て JavaScript で記述している(せざるを得ない)ため、利用者側にも公開されている。すなわち、知識があり悪意のあるユーザーは簡単に不正が可能。
- `LocalStorage`に保存されている情報は、ユーザー側で改ざんが可能。
- たとえアルゴリズム・鍵を非公開にできたとしても、頻度分析に圧倒的に弱いため、推測が容易である。

という深刻な弱点があるので、暗号化とは呼べず、セキュリティ的には致命的な欠陥が存在する。そのため、不正を面倒にするアルゴリズムという程度に捉えるべきである。

## 実験:10 人で、従来の紙チケットでの入場とこのシステムでの入場の比較

私たちは、この QR コードによる外苑祭の受付システムを実際に利用して、どのくらい効率化したか、そして利用しての感想を調べた。

### 方法

- 校内入場で受付する場面を想定。
- 従来の方法は、以下の通り。

  1. 招待券を出してもらい、裏面に書かれた学年・クラスから、誰の招待かを確認する。
  2. 保護者か友人かを確認して、「招待した人」「間柄」を名簿に記録。
  3. パンフレットおよび投票番号を渡す。
  4. 保護者なら「保護者」と書かれたネームプレートを渡す。

- このシステムの運用方法は、以下の通り。

  1. チケット読み取りページを開いた iPad を事前に用意し、それに各自の端末で表示または印刷した QR コードをかざす。
  2. 「読み取り成功」と表示されたら、画面に表示された内容から、「保護者」と書かれたネームプレートを渡すかどうか判断する。
  3. パンフレットを渡す。

  このシステムでは、投票番号は QR コードの番号を用いることができるので不要で、また、記録は自動的に行われるのでやらなくて良い。

- この実験では、被験者にはランダムに学年・クラス・番号が書かれた紙のチケットを配布し、間柄も自由に答えてもらうようにした。また、デジタルチケットについても情報はランダムで、事前に「このリンクを開いて出てくる QR コードを読み込ませてください。」とだけ伝えた。なお、被験者はこのシステムの開発には携わっていない。

### 結果

- 従来の方法: 〇〇分
- このシステム: 〇〇分

上の結果より、QR コードによる外苑祭の受付システムの方が、従来の紙チケットでの入場と比較して 〇〇% 時間が短く済んだことがわかった。

### 利用者の感想

(例)

- 今までの方法より圧倒的に早く、やりやすい。
- ページの読み込みが遅い。
- ダークテーマの方が良いのでは?

などと、好意的な意見が多く、このシステムに反対する人はいなかった。

### 実際に使ってみて見えた課題

(例)

- バグが生じてうまく開けない人がいた。
- 事前に「開いておいてください。」と呼びかけないと、結局アプリを開くので時間がかかってしまった。

## イレギュラーへの対応の考察

### QR コードが開けない場合

#### 想定

- スマホの電波が悪く、QR コードを表示できない。
- 誰からの招待で、見る公演のクラス・回は分かる。ただし、招待した人の出席番号はわからない。

#### 対応策

この状況においては、誰からの招待かがわかるので不審者の可能性は低く、従来の受付方法で対応できそうである。そのため、招待した人の名前・その人との関係を記録した上で、事前に各公演の QR コードを複数枚印刷しておいたものを渡せば、クラスでの入場も問題なく行えると考える。

### 全員がサイトを開けなくなった・致命的なバグが発生した

#### 状況

- サーバーの強度が弱く、一度に 1000 人以上のアクセスがあったためサーバーがダウンした。そのため、サイトが表示できなくなり、全員チケットを表示できなくなった。
- すぐにサーバーを復旧することは困難である。

#### バグが生じたときの対応 考察

この状況においては、QR コードで入場するシステムを維持することは困難である。そのため、この状況に陥らないよう十分な対策をして、かつこの状況に陥っても大丈夫なような工夫をする必要がある。以下に具体例を挙げる。

- QR コードは URL ではなくてスクリーンショットを共有するようにする、あるいは必ずスクリーンショットをあらかじめ保存してもらう。
- QR コードを読み取るシステムと表示するシステムで、サーバーを分ける。現在のコードでは、すべてクライアントで処理をしているので、サーバーを分けても問題がない。他のホスティングサービスを使用するなど、無料でできる方法もある。
- 現在、読み取りシステムでは、万が一サーバーがダウンしても再度読み込みをしなければそのまま続行できるようになっている。これを、サーバーがダウンしているときに再度読み込みしても大丈夫なような仕組みを調べてみたい。
- 万が一リンクしか持っていない人がいても、QR コードのデータは URL に含まれているので、それを手入力することで入場することができる。
- 読み取りシステムが開けなくなった場合に備えて、Excel 等の表計算ソフトで、QR コードの内容を直接入力すれば判定できるものを作る。

このように、何かが動かなくなっても大丈夫にするような対策を、何重にもしておくことが重要だと考える。

## 現在の課題・今後の展望

現在の課題で最も重大なことは、サーバーサイド環境を用意するためには、レンタルサーバーなどの有料サービスが必要になってしまうので構築しておらず、下のようなことができないことである。

- 各公演で何枚まで、という発行する枚数を制限することができない。
- 読み取り履歴を共通の場所に保存できない。現在はそれぞれの端末に保存されているだけなので、異なる端末でスキャンすれば再入場を検出できない。
- 暗号が非常に弱い。サーバーで発行するだけで安全性が大きく上がる。

また、その他にも

- グループで来た人への対応。一人一人 QR コードを読み取るのではかえって不便で時間がかかり、かといって QR コードをまとめる機能を追加すると、仕組みが複雑になってわかりづらいものになる。
- 複数の公演を見る予定の人だと、ページを開くまでどの公演かわからないので、チケットを探すのが大変である。かといって、まとめる機能を追加するとユーザー登録が必要になるなど、かえってより複雑でわかりづらいものになってしまう。
- 来年、再来年と使用する時に、データを削除する仕組みや、年号などの情報を更新するシステム、メンテナンス担当者などがいない。

という課題がある。今後はこれらの課題を解決するために、予算を確保してサーバーサイドのシステムを構築していくのと、実験やアンケートなどを通して使いやすいシステムというものを模索していきたいと思う。

## 終わりに

この QR コードによる外苑祭の受付システムは、受付の混雑や来場者数の統計の効率化に大きな貢献をすることがわかった。来年までに実用化できるよう、さまざまな改善を重ねるとともに、外苑祭総務や関係の先生方と相談して、より便利なシステムになるよう努力していきたい。
